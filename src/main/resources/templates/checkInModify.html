<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <meta charset="utf-8"/>
    <title>次日航班信息修改</title>
    <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
    <!--<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"-->
    <!--integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">-->
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}"/>
    <link rel="stylesheet" th:href="@{/css/registration.css}"/>
    <!-- 引用jquery -->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>-->
    <script th:src="@{/js/jquery.min.js}" type="text/javascript"></script>
    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"-->
    <!--integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"-->
    <!--crossorigin="anonymous"></script>-->
    <script th:src="@{/js/bootstrap.min.js}" type="text/javascript"></script>
    <!-- 引入bootstrap 时间组件 -->
    <link rel="stylesheet" media="screen" th:href="@{/css/bootstrap-datetimepicker.min.css}"/>
    <script th:src="@{/js/bootstrap-datetimepicker.min.js}" type="text/javascript"></script>
    <script type="text/javascript" th:src="@{/js/bootstrap-datetimepicker.zh-CN.js}"></script>
</head>
<body>
<div class="mainContainer">
    <form method="post" id="myForm">
        <div class="form-group">
            <div class="text-center">
                <h2>次日航班信息修改</h2>
            </div>
        </div>
        <input hidden id="recordId" name="id" th:value="${registration.id}">
        <div class="row">
            <div class="form-group col-sm-offset-1 col-sm-5">
                <label for="flightNumber" class="control-label">航班号：</label>
                <div class="">
                    <input type="text" class="form-control" id="flightNumber" th:value="${registration.flightNumber}"
                           placeholder="请输入航班号" required>
                </div>
            </div>
            <div class="form-group col-sm-5">
                <label for="destination" class="control-label">目的地：</label>
                <div>
                    <input type="text" class="form-control" id="destination" th:value="${registration.destination}"
                           placeholder="请输入目的地" required>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-sm-offset-1 col-sm-5">
                <label for="planeNumber" class="control-label">机号：</label>
                <div class="">
                    <input type="text" class="form-control" id="planeNumber" th:value="${registration.planeNumber}"
                           placeholder="请输入机号" required>
                </div>
            </div>
            <div class="form-group col-sm-5">
                <label for="dtp_input1" class="control-label">登机时间：</label>
                <div class="input-group date form_datetime "
                     data-date-format="yyyy年MMdd日 - HH:ii p" data-link-field="dtp_input1">
                    <input class="form-control" size="16" type="text"
                           th:value="${#dates.format(registration.boardingTime, 'yyyy年MM月dd日 - HH:mm')}" readonly>
                    <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
                    <span class="input-group-addon"><span class="glyphicon glyphicon-th"></span></span>
                </div>
                <input type="hidden" id="dtp_input1" th:value="${registration.boardingTime}" readonly required/><br/>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-sm-offset-1 col-sm-5">
                <label for="gatePosition" class="control-label">停机位：</label>
                <div class="">
                    <input type="text" class="form-control" id="gatePosition" th:value="${registration.gatePosition}"
                           placeholder="请输入停机位" required>
                </div>
            </div>
            <div class="form-group col-sm-5">
                <label for="specialFlight" class="control-label">特殊航班：</label>
                <div id="specialFlight">
                    <label class="checkbox-inline" style="margin-left: 0;margin-right: 10px;"
                           th:each="specialFlightTag,iterStat:${specialFlightTags}">
                        <input type="checkbox" name="specialFlightTag"
                               th:id="|specialFlightTag${specialFlightTag.id}|" th:value=${specialFlightTag.id}>
                        <span>[[${specialFlightTag.describe}]]</span>
                        <br th:with="isEven=(${iterStat.count} % 5 ==0)">
                    </label>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-sm-offset-1 col-sm-5">
                <label for="airportOfDeparture" class="control-label">始发站：</label>
                <div class="">
                    <input type="text" class="form-control" id="airportOfDeparture"
                           th:value="${registration.departureStation}" placeholder="请输入始发站">
                </div>
            </div>
            <div class="form-group col-sm-5">
                <label for="important" class="control-label">重点旅客标记：</label>
                <div id="important">
                    <label class="checkbox-inline" style="margin-left: 0;margin-right: 10px;"
                           th:each="passengerTag,iterStat:${passengerTags}">
                        <input type="checkbox" name="passengerTag" th:id="|passengerTag${passengerTag.id}|"
                               th:value=${passengerTag.id}>
                        <span>[[${passengerTag.describe}]]</span>
                        <br th:with="isEven=(${iterStat.count} % 5 ==0)">
                    </label>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="form-group col-sm-offset-1 col-sm-10">
                <label for="specialCircumstances" class="control-label">特殊情况说明：</label>
                <div class="">
                    <textarea class="form-control" rows="3"
                              id="specialCircumstances">[[${registration.special}]]</textarea>
                </div>
            </div>
        </div>
        <br>
        <div class="row">
            <div class="col-sm-offset-2 col-sm-2">
                <button type="reset" class="btn btn-lg btn-danger btn-block">全部清空</button>
            </div>
            <div class="col-sm-offset-3 col-sm-2">
                <button type="button" id="check-btn" class="btn btn-lg btn-success btn-block" onclick="checkMessage()">
                    上传
                </button>
            </div>
        </div>
        <div id="myTag"></div>
    </form>
</div>
</body>
<script type="text/javascript" th:inline="javascript">
    $(document).ready(function () {
        var passengerTags = [[${registration.passengerTags}]];
        // 将传来的交钱列表设置为选中状态
        for (var i = 0; i < passengerTags.length; i++) {
            var id = "passengerTag" + passengerTags[i];
            $("#" + id).attr("checked", true);
        }
        var specialTags = [[${registration.specialTags}]];
        // 将传来的交钱列表设置为选中状态
        for (var i = 0; i < specialTags.length; i++) {
            var id = "specialFlightTag" + passengerTags[i];
            $("#" + id).attr("checked", true);
        }
    });
</script>
</html>
<script type="text/javascript">
    $('.form_datetime').datetimepicker({
        weekStart: 0, //一周从哪一天开始
        todayBtn: 1, //
        autoclose: 1,
        language: 'zh-CN',
        todayHighlight: 1,
        startView: 2,
        forceParse: 0,
        showMeridian: 1,
        minuteStep: 1
    });

    var isNull = function (obj) {
        return obj;
    };

    var checkMessage = function () {
        // 进入函数，将按钮设置为不可用状态
        $("#check-btn").attr("disabled", "disabled");
        // 获取各个输入的值
        console.log("执行检查函数");
        var recordID = $("#recordId").val();
        if (!isNull(recordID)) {
            console.log("信息有误！");
            alert("系统出错！正在重定向。")
            // 重定向到当前页面
            window.location.href = "/registration/modify";
            return false;
        }
        var flightNumber = $("#flightNumber").val();
        console.log("航班号" + flightNumber);
        var destination = $("#destination").val();
        console.log("目的地" + destination);
        var planeNumber = $("#planeNumber").val();
        console.log("机号" + planeNumber);
        var dtp_input1 = $("#dtp_input1").val();
        console.log("登机时间" + dtp_input1);
        if (!isNull(dtp_input1)) {
            console.log("时间为空");
            alert("请填写登机时间！");
            $("#dtp_input1")[0].focus();
            return false;
        }
        var boardingTime = new Date(dtp_input1).getTime();
        console.log(boardingTime);

        var gatePosition = $("#gatePosition").val();
        console.log("停机位" + gatePosition);
        var airportOfDeparture = $("#airportOfDeparture").val();
        console.log("始发站" + airportOfDeparture);
        var specialCircumstances = $("#specialCircumstances").val();
        console.log("特殊情况说明" + specialCircumstances);

        // 重点旅客标记
        var passengerTagCheckValue = [];
        $('input[name="passengerTag"]:checked').each(function () {
            passengerTagCheckValue.push($(this).val());//向数组中添加元素  
        });
        var checkStr = passengerTagCheckValue.join(',');//将数组元素连接起来以构建一个字符串  
        console.log(checkStr);
        // 特殊航班标记
        var specialFlightTagCheckValue = [];
        $('input[name="specialFlightTag"]:checked').each(function () {
            specialFlightTagCheckValue.push($(this).val());//向数组中添加元素  
        });
        checkStr = specialFlightTagCheckValue.join(',');//将数组元素连接起来以构建一个字符串  
        console.log(checkStr);
        var registration = {};
        // 记录id
        registration.id = recordID;
        // 航班号
        registration.flightNumber = flightNumber;
        // 机号
        registration.planeNumber = planeNumber;
        // 登机时间
        registration.boardingTime = boardingTime;
        // 停机位
        registration.gatePosition = gatePosition;
        // 始发站
        registration.departureStation = airportOfDeparture;
        // 目的地
        registration.destination = destination;
        // 特殊情况说明
        registration.special = specialCircumstances;
        // 特殊航班标记
        registration.specialTags = specialFlightTagCheckValue;
        // 重点旅客标记
        registration.passengerTags = passengerTagCheckValue;
        var message = JSON.stringify(registration);
        console.log("组装的对象 ： " + message);


        $.ajax({
            type: "POST",
            url: "/registration/modify",
            dataType: 'json',
            data: {
                "dataMessage": message
            },
            // ajax请求成功，并不代表数据处理成功，还需要判断处理
            success: function (response) {
                //实际操作的时候，返回的json对象中可能会有成功错误的判断标记，所以可能也需要判断一下
                console.log("返回的数据: " + response.data);
                if (response.status === 200) {
                    // 请求成功
                    alert("记录添加成功,现在返回！");
                    // 数据修改成功，重新跳转回查询界面
                    window.location.href = "/registration/search";
                } else {
                    alert("修改失败，请稍后重试！");
                }

            },
            error: function (xhr) {
                console.log("错误提示： " + xhr + " ---- " + xhr.status + " " + xhr.statusText);
            },
            //请求完成后回调函数 (请求成功或失败之后均调用)。参数： XMLHttpRequest 对象和一个描述成功请求类型的字符串
            complete: function (XMLHttpRequest, textStatus) {
                console.log("函数调用完成，将按钮设置为可用状态");
                // 请求完成，将按钮重置为可用
                $("#check-btn").removeAttr("disabled");
            }
        });
    };
</script>